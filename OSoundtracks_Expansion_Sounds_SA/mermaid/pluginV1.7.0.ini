flowchart TD
    A[🚀 SKSE Plugin Load] --> B[📁 Inicialización Segura<br/>GetDocumentsPath + GetGamePath<br/>CreateDirectoryIfNotExists]
    B --> C[⚙️ Leer Config Backup INI<br/>ReadBackupConfigFromIni<br/>Crear si no existe con Backup=1]
    C --> D[🔍 Validación SIMPLE JSON<br/>PerformSimpleJsonIntegrityCheck<br/>Estructura, balance, claves OBody]
    
    D --> E{❓ JSON Maestro<br/>Válido?}
    E -->|NO| F[❌ TERMINAR PROCESO<br/>JSON Corrupto - CRITICAL ERROR<br/>No hay restauración automática en V1.7.2]
    E -->|SÍ| G{🔄 Backup<br/>Config?}
    
    G -->|Backup=1| H[💾 Backup LITERAL<br/>PerformLiteralJsonBackup<br/>Copia byte-por-byte]
    G -->|Backup=true/2| H1[💾 Backup LITERAL<br/>Modo Siempre Activo<br/>No actualizar INI]
    G -->|Backup=0| I[📖 Leer JSON Maestro<br/>ReadCompleteJson<br/>Parsear 8 claves válidas]
    
    H --> J[✏️ Actualizar INI<br/>UpdateBackupConfigInIni<br/>Backup = 0]
    H1 --> K[ℹ️ Mantener INI<br/>Backup = true sin cambios]
    J --> I
    K --> I
    
    I --> L{✅ Lectura JSON<br/>readSuccess?}
    L -->|NO| M[🔄 Restaurar desde Backup<br/>RestoreJsonFromBackup<br/>Manual restoration attempt]
    M --> N[📁 Mover Corrupto<br/>MoveCorruptedJsonToAnalysis<br/>Timestamp único → Analysis]
    N --> O[🔄 Reintentar Lectura<br/>ReadCompleteJson]
    O --> P{✅ Lectura OK<br/>después de restaurar?}
    P -->|NO| Q[❌ TERMINAR PROCESO<br/>JSON READ FAILED]
    P -->|SÍ| R[📂 Escanear Data Folder<br/>directory_iterator<br/>OBodyNG_PDA_*.ini]
    
    L -->|SÍ| R
    R --> S[📝 Procesar Reglas INI<br/>ParseRuleLine + validKeys<br/>Add/Remove Presets/Plugins<br/>Conteos dinámicos]
    S --> T[🔢 Actualizar Conteos INI<br/>UpdateIniRuleCount<br/>Decrementar automático]
    T --> U[📊 Log Summary Detallado<br/>Estadísticas completas<br/>Rules/Files/Presets/Plugins]
    
    U --> V[🏗️ Preservar Original<br/>PreserveOriginalSections<br/>Actualizar solo claves modificadas<br/>Formato 4 espacios exactos]
    V --> W[💾 Escritura ATÓMICA<br/>WriteJsonAtomically<br/>Archivo .tmp + PerformTripleValidation]
    
    W --> X{✅ Escritura<br/>Exitosa?}
    X -->|NO| Y[🔄 Restaurar Backup<br/>RestoreJsonFromBackup<br/>Fallo de escritura]
    X -->|SÍ| Z[🔍 CORRECCIÓN INDENTACIÓN<br/>CorrectJsonIndentation<br/>Básica - SIN detección avanzada]
    
    Z --> AA{📏 Indentación<br/>Ya Correcta?}
    AA -->|SÍ| BB[✅ JSON Ya Perfecto<br/>4 espacios básicos<br/>Sin detección multi-línea avanzada]
    AA -->|NO| CC[✏️ REFORMATEAR BÁSICO<br/>4 espacios por nivel<br/>Sin isEmptyBlock helper avanzado]
    
    CC --> DD{✅ Reformateo<br/>Básico Completo?}
    DD -->|NO| EE[🔄 Restaurar Backup<br/>Fallo corrección indentación]
    DD -->|SÍ| FF[🔍 Validación TRIPLE Final<br/>PerformTripleValidation<br/>Estructura + Integridad + Claves]
    
    BB --> FF
    FF --> GG{✅ JSON Final<br/>Válido?}
    GG -->|NO| HH[🔄 Restaurar Backup<br/>+ Análisis Forense<br/>MoveCorruptedJsonToAnalysis]
    GG -->|SÍ| II[📊 Log Final Success<br/>Process completed successfully<br/>Basic 4-space formatting]
    
    Y --> JJ[📊 Log Backup Restore<br/>JSON restored after write failure]
    EE --> KK[📊 Log Backup Restore<br/>JSON restored after indent failure]  
    HH --> LL[📊 Log Critical Error<br/>Could not restore from backup]
    
    JJ --> II
    KK --> II
    LL --> II
    
    II --> MM[💬 Mensaje Consola<br/>OBody Assistant: Process completed!]
    MM --> NN[🏁 FIN: Proceso Completo<br/>JSON con formato básico<br/>4-space hierarchy sin optimizaciones]
    
    F --> OO[🏁 FIN: JSON Corrupto<br/>Sin restauración automática<br/>CONTACT MODDER OR REINSTALL!]
    Q --> PP[🏁 FIN: Error Crítico<br/>JSON read failed]
    
    %% Estilos
    classDef startEnd fill:#e1f5fe,stroke:#01579b,stroke-width:3px,color:#333
    classDef process fill:#f3e5f5,stroke:#4a148c,stroke-width:2px,color:#333
    classDef decision fill:#fff3e0,stroke:#e65100,stroke-width:2px,color:#333
    classDef error fill:#ffebee,stroke:#b71c1c,stroke-width:2px,color:#333
    classDef backup fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px,color:#333
    classDef basicFeature fill:#e8eaf6,stroke:#5c6bc0,stroke-width:2px,color:#333
    classDef logFeature fill:#f1f8e9,stroke:#558b2f,stroke-width:2px,color:#333
    
    class A,NN,OO,PP startEnd
    class B,C,I,R,S,T,U,V,W process
    class E,G,L,P,X,AA,DD,GG decision
    class F,Q,Y,EE,HH error
    class H,H1,J,K,M,N backup
    class D,Z,CC,FF,BB basicFeature
    class II,JJ,KK,LL,MM logFeature
