flowchart TD
    A[ğŸš€ SKSE Plugin Load - Version 2.7.3] --> B[ğŸ“ Secure Initialization<br/>GetDocumentsPath + GetGamePath<br/>CreateDirectoryIfNotExists]
    B --> C[âš™ï¸ Read Config INI<br/>ReadConfigFromIni<br/>Backup, ModeUBE, ModeHIMBO<br/>Smart Cleaning flags<br/>Conflict Resolution flag]
    C --> D[ğŸ” SIMPLE JSON Validation<br/>PerformSimpleJsonIntegrityCheck<br/>Structure, balance, OBody keys]

    D --> E{â“ Master JSON<br/>Valid?}
    E -->|YES| G{ğŸ”„ Backup<br/>Config?}
    E -->|NO| F1[ğŸ”„ AUTOMATIC RESTORE<br/>RestoreJsonFromBackup<br/>Attempt recovery from backup]

    F1 --> F2{âœ… Restoration<br/>Successful?}
    F2 -->|YES| F3[ğŸ“Š Log: JSON Restored<br/>Continue normal process]
    F2 -->|NO| F[âŒ END PROCESS<br/>CRITICAL ERROR<br/>No valid backup available]
    F3 --> G

    G -->|Backup=1| H[ğŸ’¾ LITERAL Backup<br/>PerformLiteralJsonBackup<br/>Byte-by-byte copy]
    G -->|Backup=true/2| H1[ğŸ’¾ LITERAL Backup<br/>Always Active Mode<br/>Keep INI unchanged]
    G -->|Backup=0/false| I[ğŸ“– Read Master JSON<br/>ReadCompleteJson<br/>Parse all valid keys]

    H --> J[âœï¸ Update INI<br/>Backup = 0]
    H1 --> K[â„¹ï¸ Keep INI<br/>Backup = true unchanged]
    J --> I
    K --> I

    I --> L{âœ… JSON Read<br/>Success?}
    L -->|NO| M[ğŸ”„ Restore from Backup<br/>RestoreJsonFromBackup]
    M --> N[ğŸ“ Move Corrupted<br/>MoveCorruptedJsonToAnalysis<br/>Timestamp â†’ Analysis]
    N --> O[ğŸ”„ Retry Read<br/>ReadCompleteJson]
    O --> P{âœ… Read OK<br/>after restore?}
    P -->|NO| Q[âŒ END PROCESS<br/>JSON READ FAILED]
    P -->|YES| R[ğŸ“‚ Scan Data Folder<br/>OBodyNG_PDA_*.ini files]

    L -->|YES| R
    R --> R0[ğŸ“‹ ğŸ†• Generate INI Analysis Log<br/>GenerateINIAnalysisLog<br/>Scan all INI files<br/>Line-by-line rule detection<br/>Statistics per file]
    R0 --> R1[ğŸ“‹ Generate Doctor Log<br/>GenerateDoctorLog<br/>List all XML files found]
    R1 --> DD[ğŸ—ï¸ ğŸ†• Build MASTER Preset Map<br/>BuildPresetNameMap<br/>Phase 1: Master reference<br/>Extract internal names from XML<br/>Multi-preset support + HTML decoding]
    DD --> SS[ğŸ“‹ Generate Smart Cleaning Log<br/>GenerateSmartCleaningLog<br/>Preset reference list + mapping]
    SS --> SSS[ğŸ“‹ Generate Helper Log<br/>GenerateHelperLog<br/>Complete preset list + examples]

    SSS --> T[ğŸ“ Parse & Prioritize INI Rules<br/>ParseRuleLine + GetRulePriority<br/>Sort by priority: Standard â†’ Filter â†’ Remove â†’ Exclusive]
    T --> T1{ğŸ” Detect<br/>Conflicts?}
    T1 -->|YES| T2[ğŸš¨ Track Exclusive Conflicts<br/>RuleConflictTracker<br/>File modification timestamps]
    T1 -->|NO| T7
    T2 --> T3{âš™ï¸ Smart Resolution<br/>Enabled?}
    T3 -->|YES| T4[ğŸ”§ ğŸ†• Resolve Conflicts Automatically<br/>ResolveConflicts<br/>Newest file wins â†’ Update older count to 0<br/>UpdateIniRuleCount for disabled rules]
    T3 -->|NO| T5[âš ï¸ Skip All Conflicting Rules<br/>Log conflicts only]
    T4 --> T6[ğŸ“‹ ğŸ†• Generate Conflict Report<br/>GenerateConflictReport<br/>Append to INI Analysis Log<br/>Detailed resolution + timestamps]
    T5 --> T6
    T6 --> T7

    T7[ğŸ” ğŸ†• PHASE 3.3: Pre-Scan Male Races<br/>PreScanMaleRacesInINI<br/>Detect raceMale with INI rules]
    T7 --> T8{â“ Male Races<br/>with INI Rules?}
    T8 -->|YES| T9[ğŸ§¹ ğŸ†• Selective HIMBO Cleaning<br/>CleanHIMBOFromSpecificMaleRaces<br/>Remove HIMBO only from detected races<br/>Other races preserve all HIMBO]
    T8 -->|NO| U
    T9 --> U

    U[ğŸ¯ Process INI Rules<br/>Apply by priority order<br/>Add/Remove Presets/Plugins<br/>Support 43 rule modes]
    U --> U1[ğŸ”‘ Process KEY Filtering Modes<br/>KeyWord/KeyWordChart/KeyAuthor<br/>KeyNormal/KeyUBE/KeyHIMBO<br/>With asterisk, dash, 1 variants]
    U1 --> U2[ğŸ“Š ğŸ†• Update INI Counts Dynamically<br/>UpdateIniRuleCount<br/>Automatic decrement for ONCE modes<br/>Write back to INI files in real-time]

    U2 --> V[ğŸ§¹ Smart Cleaning Evaluation<br/>Check enabled flags per section<br/>Using Master Preset Map]
    V --> V1{ğŸ›¡ï¸ Presets<br/>Smart Cleaning?}
    V1 -->|YES| V2A[ğŸ” Clean General Presets<br/>6-level matching algorithm<br/>Protected presets exemption<br/>Master Map validation]
    V1 -->|NO| V3A
    V2A --> V3A{ğŸ›¡ï¸ Blacklisted Presets<br/>FromRandomDistribution?}
    V3A -->|YES| V4A[ğŸ” Clean Blacklist Random<br/>PerformSmartCleaning]
    V3A -->|NO| V5A
    V4A --> V5A{ğŸ›¡ï¸ Blacklisted Presets<br/>FromAll?}
    V5A -->|YES| V6A[ğŸ” Clean All Blacklists<br/>PerformSmartCleaning]
    V5A -->|NO| V7A
    V6A --> V7A{ğŸ›¡ï¸ OutfitsForceRe<br/>Smart Cleaning?}
    V7A -->|YES| V8A[ğŸ” Clean Outfits ForceRefit<br/>PerformSmartCleaning<br/>ğŸ†• BYPASSED: Preserved as-is]
    V7A -->|NO| W
    V8A --> W

    W[ğŸ® UBE/HIMBO XML Processing<br/>ProcessUBEXmlPresets + ProcessHIMBOXmlPresets<br/>Multi-preset extraction]
    W --> W1{ğŸ” ModeUBE<br/>Enabled?}
    W1 -->|YES| W2[ğŸ“Š Analyze UBE XMLs<br/>AnalyzeXmlGroups<br/>Detect 3BA/3BBB/CBBE conflicts]
    W1 -->|NO| W9
    W2 --> W3{âš ï¸ UBE Conflict<br/>Detected?}
    W3 -->|YES + UBE in name| W4[âœ… Add to Blacklist + UBE Races<br/>Allow in 22 UBE races]
    W3 -->|YES + NO UBE in name| W5[âœ… Add to Blacklist ONLY<br/>Exclude from UBE races]
    W3 -->|NO Conflict| W6[âœ… Add to Blacklist + UBE Races<br/>Pure UBE preset]
    W4 --> W7
    W5 --> W7
    W6 --> W7
    W7[ğŸ¯ Apply UBE to JSON<br/>Blacklist + 22 UBE Races]
    W7 --> W9

    W9{ğŸ” ModeHIMBO<br/>Enabled?}
    W9 -->|YES| W10[ğŸ“Š Analyze HIMBO XMLs<br/>AnalyzeXmlGroups<br/>Detect conflicts]
    W9 -->|NO| X
    W10 --> W11{âš ï¸ HIMBO Conflict<br/>Detected?}
    W11 -->|YES + HIMBO in name| W12[âœ… Add to Blacklist + HIMBO Races<br/>Allow in 22 HIMBO races]
    W11 -->|YES + NO HIMBO in name| W13[âœ… Add to Blacklist ONLY<br/>Exclude from HIMBO races]
    W11 -->|NO Conflict| W14[âœ… Add to Blacklist + HIMBO Races<br/>Pure HIMBO preset]
    W12 --> W15
    W13 --> W15
    W14 --> W15
    W15[ğŸ¯ Apply HIMBO to JSON<br/>Blacklist + 22 HIMBO races]
    W15 --> X

    X[ğŸ—ï¸ Preserve Original<br/>PreserveOriginalSections<br/>Update only modified keys<br/>Exact 4-space format]
    X --> ZZ{ğŸ” VERIFY CHANGES<br/>CheckIfChangesNeeded?}

    ZZ -->|YES| AA[ğŸ’¾ ATOMIC Write<br/>WriteJsonAtomically<br/>.tmp + PerformTripleValidation]
    ZZ -->|NO| BB[â„¹ï¸ Skip Write<br/>No changes detected]

    AA --> CC{âœ… Write<br/>Successful?}
    CC -->|NO| YY[ğŸ”„ Restore Backup<br/>Write failure]
    CC -->|YES| DD1[ğŸ” INDENTATION CORRECTION<br/>CorrectJsonIndentation<br/>4-space hierarchy + inline empty]
    BB --> DD1

    DD1 --> EE{ğŸ“ Indentation<br/>Correct?}
    EE -->|YES| FF[âœ… JSON Already Perfect<br/>4 spaces verified]
    EE -->|NO| GG[âœï¸ FULL REFORMAT<br/>isEmptyBlock Helper<br/>Empty containers inline<br/>With content 4 spaces]

    GG --> HH{âœ… Reformat<br/>Complete?}
    HH -->|NO| II[ğŸ”„ Restore Backup<br/>Indentation failure]
    HH -->|YES| JJ[ğŸ” Final TRIPLE Validation<br/>PerformTripleValidation<br/>Structure + Keys]

    FF --> JJ
    JJ --> KK{âœ… Final JSON<br/>Valid?}
    KK -->|NO| LL[ğŸ”„ Restore Backup<br/>+ Forensic Analysis]
    KK -->|YES| MM[ğŸ“Š ğŸ†• Final Log Summary<br/>Complete statistics<br/>All operations logged<br/>5 logs generated:<br/>- Main Log<br/>- INI Analysis<br/>- Doctor<br/>- Smart Cleaning<br/>- Helper]

    YY --> NN[ğŸ“Š Log Backup Restore]
    II --> OO[ğŸ“Š Log Backup Restore]
    LL --> PP[ğŸ“Š Log Critical Error]

    NN --> MM
    OO --> MM
    PP --> MM

    MM --> QQ[ğŸ’¬ Console Message<br/>OBody Assistant v2.7.3: Process completed!]
    QQ --> ZZZ{ğŸ” ğŸ†• WIP MCM ACTIVATION?<br/>Check Control INI exists}
    ZZZ -->|YES| ZZZ1[âœï¸ ğŸ†• WIP RESET CONTROL INI<br/>WriteControlIniValue<br/>startAct1 = false<br/>Ready for next activation]
    ZZZ -->|NO| RR
    ZZZ1 --> RR[ğŸ END: Success<br/>Perfect 4-space format<br/>ğŸ†• MCM Activation System WIP<br/>ğŸ†• Selective HIMBO Cleaning<br/>ğŸ†• 5 logs generated<br/>ğŸ†• INI auto-update for ONCE modes<br/>ğŸ†• Smart Conflict Resolution<br/>UBE + HIMBO distributed<br/>43 rule modes supported]

    F --> SS1[ğŸ END: Critical Error]
    Q --> TT[ğŸ END: JSON Read Failed]

    %% Styles
    classDef startEnd fill:#e1f5fe,stroke:#01579b,stroke-width:3px,color:#333
    classDef process fill:#f3e5f5,stroke:#4a148c,stroke-width:2px,color:#333
    classDef decision fill:#fff3e0,stroke:#e65100,stroke-width:2px,color:#333
    classDef error fill:#ffebee,stroke:#b71c1c,stroke-width:2px,color:#333
    classDef backup fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px,color:#333
    classDef newFeature fill:#e3f2fd,stroke:#0277bd,stroke-width:3px,color:#333
    classDef smartCleaning fill:#fff9c4,stroke:#f57f17,stroke-width:3px,color:#333
    classDef ubeFeature fill:#f3e5f5,stroke:#7b1fa2,stroke-width:3px,color:#333
    classDef himboFeature fill:#e1bee7,stroke:#6a1b9a,stroke-width:3px,color:#333
    classDef logFeature fill:#f1f8e9,stroke:#558b2f,stroke-width:2px,color:#333
    classDef conflictFeature fill:#ffccbc,stroke:#d84315,stroke-width:3px,color:#333
    classDef keyFeature fill:#b2dfdb,stroke:#00695c,stroke-width:3px,color:#333
    classDef newv273Feature fill:#ffebee,stroke:#c62828,stroke-width:4px,color:#333,font-weight:bold

    class A,RR,SS1,TT startEnd
    class B,C,I,R,X,AA process
    class E,G,L,P,CC,EE,HH,KK,F2,ZZ,V1,V3A,V5A,V7A,W1,W3,W9,W11,T1,T3,T8,ZZZ decision
    class F,Q,YY,II,LL error
    class H,H1,J,K,M,N backup
    class D,DD1,GG,JJ newFeature
    class V,V2A,V4A,V6A,V8A smartCleaning
    class W,W2,W3,W4,W5,W6,W7 ubeFeature
    class W10,W11,W12,W13,W14,W15 himboFeature
    class R1,SS,SSS,MM,NN,OO,PP,QQ,F3 logFeature
    class T2,T5,T6 conflictFeature
    class T,U,U1 keyFeature
    class R0,DD,U2,T4,V8A,T7,T9,ZZZ,ZZZ1 newv273Feature
