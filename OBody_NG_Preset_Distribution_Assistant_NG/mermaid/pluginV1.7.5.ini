flowchart TD
    A[ğŸš€ SKSE Plugin Load] --> B[ğŸ“ InicializaciÃ³n Segura<br/>GetDocumentsPath + GetGamePath<br/>CreateDirectoryIfNotExists]
    B --> C[âš™ï¸ Leer Config Backup INI<br/>ReadBackupConfigFromIni<br/>Crear si no existe con Backup=1]
    C --> D[ğŸ” ValidaciÃ³n SIMPLE JSON<br/>PerformSimpleJsonIntegrityCheck<br/>Estructura, balance, claves OBody]
    
    D --> E{â“ JSON Maestro<br/>VÃ¡lido?}
    E -->|SÃ| G{ğŸ”„ Backup<br/>Config?}
    E -->|NO| F1[ğŸ”„ RESTAURAR AUTOMÃTICO<br/>RestoreJsonFromBackup<br/>Intentar recuperar desde backup]
    
    F1 --> F2{âœ… RestauraciÃ³n<br/>Exitosa?}
    F2 -->|SÃ| F3[ğŸ“Š Log: JSON Restaurado<br/>Continuar proceso normal]
    F2 -->|NO| F[âŒ TERMINAR PROCESO<br/>JSON Corrupto sin backup vÃ¡lido<br/>CRITICAL ERROR + acciones recomendadas]
    F3 --> G
    
    G -->|Backup=1| H[ğŸ’¾ Backup LITERAL<br/>PerformLiteralJsonBackup<br/>Copia byte-por-byte a Backup_OBody_DPA]
    G -->|Backup=true/2| H1[ğŸ’¾ Backup LITERAL<br/>Modo Siempre Activo<br/>No actualizar INI â†’ Backup_OBody_DPA]
    G -->|Backup=0| I[ğŸ“– Leer JSON Maestro<br/>ReadCompleteJson<br/>Parsear 8 claves vÃ¡lidas]
    
    H --> J[âœï¸ Actualizar INI<br/>UpdateBackupConfigInIni<br/>Backup = 0]
    H1 --> K[â„¹ï¸ Mantener INI<br/>Backup = true sin cambios]
    J --> I
    K --> I
    
    I --> L{âœ… Lectura JSON<br/>readSuccess?}
    L -->|NO| M[ğŸ”„ Restaurar desde Backup<br/>RestoreJsonFromBackup<br/>Backup_OBody_DPA]
    M --> N[ğŸ“ Mover Corrupto<br/>MoveCorruptedJsonToAnalysis<br/>Timestamp Ãºnico â†’ Analysis]
    N --> O[ğŸ”„ Reintentar Lectura<br/>ReadCompleteJson]
    O --> P{âœ… Lectura OK<br/>despuÃ©s de restaurar?}
    P -->|NO| Q[âŒ TERMINAR PROCESO<br/>JSON READ FAILED]
    P -->|SÃ| R[ğŸ“‚ Escanear Data Folder<br/>directory_iterator<br/>OBodyNG_PDA_*.ini]
    
    L -->|SÃ| R
    R --> S[ğŸ“ Procesar Reglas INI<br/>ParseRuleLine + validKeys<br/>Add/Remove Presets/Plugins<br/>Conteos dinÃ¡micos]
    S --> T[ğŸ”¢ Actualizar Conteos INI<br/>UpdateIniRuleCount<br/>Decrementar automÃ¡tico]
    T --> U[ğŸ“Š Log Summary Detallado<br/>EstadÃ­sticas completas<br/>Rules/Files/Presets/Plugins]
    
    U --> V[ğŸ—ï¸ Preservar Original<br/>PreserveOriginalSections<br/>Actualizar solo claves modificadas<br/>Formato 4 espacios exactos]
    V --> W[ğŸ’¾ Escritura ATÃ“MICA<br/>WriteJsonAtomically<br/>Archivo .tmp + PerformTripleValidation]
    
    W --> X{âœ… Escritura<br/>Exitosa?}
    X -->|NO| Y[ğŸ”„ Restaurar Backup<br/>RestoreJsonFromBackup<br/>Fallo de escritura]
    X -->|SÃ| Z[ğŸ” CORRECCIÃ“N INDENTACIÃ“N<br/>CorrectJsonIndentation<br/>Detectar Empty Containers Multi-lÃ­nea]
    
    Z --> AA{ğŸ“ IndentaciÃ³n<br/>Ya Correcta?}
    AA -->|SÃ| BB[âœ… JSON Ya Perfecto<br/>4 espacios + inline empty<br/>Multi-line empty detection]
    AA -->|NO| CC[âœï¸ REFORMATEAR COMPLETO<br/>isEmptyBlock Helper<br/>Empty containers inline<br/>Con contenido 4 espacios]
    
    CC --> DD{ğŸ”§ isEmptyBlock<br/>Multi-lÃ­nea + inline?}
    DD -->|Container VacÃ­o| EE[ğŸ“ Escribir inline<br/>containers o arrays mismo lÃ­nea]
    DD -->|Con Datos| FF[ğŸ“ Formato estÃ¡ndar<br/>4 espacios por nivel]
    
    EE --> GG[ğŸ”„ Continuar parsing<br/>Siguiente container]
    FF --> GG
    GG --> HH{âœ… Reformateo<br/>Completo?}
    
    HH -->|NO| II[ğŸ”„ Restaurar Backup<br/>Fallo correcciÃ³n indentaciÃ³n]
    HH -->|SÃ| JJ[ğŸ” ValidaciÃ³n TRIPLE Final<br/>PerformTripleValidation<br/>Estructura + Integridad + Claves]
    
    BB --> JJ
    JJ --> KK{âœ… JSON Final<br/>VÃ¡lido?}
    KK -->|NO| LL[ğŸ”„ Restaurar Backup<br/>+ AnÃ¡lisis Forense<br/>MoveCorruptedJsonToAnalysis]
    KK -->|SÃ| MM[ğŸ“Š Log Final Success<br/>Process completed successfully<br/>Perfect 4-space formatting]
    
    Y --> NN[ğŸ“Š Log Backup Restore<br/>JSON restored after write failure]
    II --> OO[ğŸ“Š Log Backup Restore<br/>JSON restored after indent failure]  
    LL --> PP[ğŸ“Š Log Critical Error<br/>Could not restore from backup]
    
    NN --> MM
    OO --> MM
    PP --> MM
    
    MM --> QQ[ğŸ’¬ Mensaje Consola<br/>OBody Assistant: Process completed!]
    QQ --> RR[ğŸ FIN: Proceso Completo<br/>JSON con formato perfecto<br/>Inline empty + 4-space hierarchy<br/>Carpeta: Backup_OBody_DPA]
    
    F --> SS[ğŸ FIN: JSON Corrupto<br/>Sin backup vÃ¡lido disponible<br/>CONTACT MODDER OR REINSTALL!]
    Q --> TT[ğŸ FIN: Error CrÃ­tico<br/>JSON read failed]
    
    %% Estilos actualizados
    classDef startEnd fill:#e1f5fe,stroke:#01579b,stroke-width:3px,color:#333
    classDef process fill:#f3e5f5,stroke:#4a148c,stroke-width:2px,color:#333
    classDef decision fill:#fff3e0,stroke:#e65100,stroke-width:2px,color:#333
    classDef error fill:#ffebee,stroke:#b71c1c,stroke-width:2px,color:#333
    classDef backup fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px,color:#333
    classDef newFeature fill:#e3f2fd,stroke:#0277bd,stroke-width:3px,color:#333
    classDef inlineFeature fill:#fff9c4,stroke:#f57f17,stroke-width:3px,color:#333
    classDef logFeature fill:#f1f8e9,stroke:#558b2f,stroke-width:2px,color:#333
    classDef autoRestore fill:#e8eaf6,stroke:#3f51b5,stroke-width:3px,color:#333
    
    class A,RR,SS,TT startEnd
    class B,C,I,R,S,T,U,V,W process
    class E,G,L,P,X,AA,DD,HH,KK,F2 decision
    class F,Q,Y,II,LL error
    class H,H1,J,K,M,N backup
    class D,Z,CC,JJ newFeature
    class EE,FF,GG,BB inlineFeature
    class MM,NN,OO,PP,QQ,F3 logFeature
    class F1 autoRestore
